# 测试指南

## 🧪 如何测试地图切换功能

### 测试环境准备

1. **启动开发服务器**
   ```bash
   npm run dev
   # 或
   yarn dev
   ```

2. **打开浏览器控制台**
   - Chrome: F12 或 Ctrl+Shift+I
   - 查看 Console 标签页

---

## 📝 测试用例

### 测试用例 1: 首次加载中国地图

**步骤**:
1. 打开应用
2. 观察加载过程

**预期结果**:
- ✅ 显示 "加载中国地图中..." 的 Loading 动画
- ✅ 约 300ms 后地图出现
- ✅ 地图完整可见，无需缩放
- ✅ 控制台显示: `初始化完成，缓存地图: china-34`

**通过标准**:
- Loading 动画流畅
- 地图显示完整
- 加载时间 < 500ms

---

### 测试用例 2: 切换到世界地图（首次）

**步骤**:
1. 点击"世界地图" Tab/按钮
2. 观察切换过程

**预期结果**:
- ✅ 显示 "加载世界地图中..." 的 Loading 动画
- ✅ 约 350ms 后世界地图出现
- ✅ 世界地图完整可见，居中显示
- ✅ 中国地图被隐藏但未销毁
- ✅ 控制台显示: `初始化完成，缓存地图: world-195`

**通过标准**:
- 切换流畅，无闪烁
- 世界地图显示正确
- 加载时间 < 500ms

---

### 测试用例 3: 切换回中国地图（使用缓存）

**步骤**:
1. 点击"中国地图" Tab/按钮
2. 观察切换速度

**预期结果**:
- ✅ **无 Loading 动画**（使用缓存）
- ✅ 瞬间切换（<50ms）
- ✅ 中国地图状态完全保留（相机位置、缩放等）
- ✅ 控制台显示: `使用缓存的地图: china-34`

**通过标准**:
- 切换速度 < 100ms
- 无重新加载迹象
- 状态完整保留

---

### 测试用例 4: 再次切换到世界地图（使用缓存）

**步骤**:
1. 点击"世界地图" Tab/按钮
2. 观察切换速度

**预期结果**:
- ✅ **无 Loading 动画**（使用缓存）
- ✅ 瞬间切换（<50ms）
- ✅ 世界地图状态完全保留
- ✅ 控制台显示: `使用缓存的地图: world-195`

**通过标准**:
- 切换速度 < 100ms
- 无重新加载迹象
- 状态完整保留

---

### 测试用例 5: 快速连续切换

**步骤**:
1. 快速点击切换按钮 10 次
2. 观察性能和稳定性

**预期结果**:
- ✅ 每次切换都流畅
- ✅ 无卡顿或白屏
- ✅ 无内存泄漏
- ✅ 动画持续运行

**通过标准**:
- FPS 保持 60
- 内存占用稳定
- 无报错

---

### 测试用例 6: 默认视角检查

**步骤**:
1. 加载中国地图，不进行任何操作
2. 切换到世界地图，不进行任何操作

**预期结果**:

**中国地图**:
- ✅ 能看到完整的中国版图
- ✅ 东部沿海到西部边境都可见
- ✅ 南部海南到北部黑龙江都可见
- ✅ 地图居中显示

**世界地图**:
- ✅ 能看到完整的世界地图
- ✅ 所有大洲都可见
- ✅ 地图居中显示
- ✅ 不会太远或太近

**通过标准**:
- 无需手动缩放
- 视角舒适
- 地图完整

---

## 🔧 交互测试

### 测试用例 7: 地图交互功能

**步骤**:
1. 在中国地图上平移、缩放
2. 切换到世界地图
3. 切换回中国地图
4. 检查之前的平移和缩放状态

**预期结果**:
- ✅ 中国地图的状态被保留
- ✅ 平移位置相同
- ✅ 缩放级别相同
- ✅ 动画继续运行

---

### 测试用例 8: 鼠标悬停功能

**步骤**:
1. 鼠标悬停在省份/国家上
2. 观察 Tooltip 显示
3. 切换地图
4. 再次测试 Tooltip

**预期结果**:
- ✅ Tooltip 正常显示
- ✅ 切换后功能正常
- ✅ 无报错

---

## 📊 性能测试

### 测试用例 9: 内存泄漏检查

**步骤**:
1. 打开 Chrome DevTools -> Memory
2. 记录初始内存
3. 切换地图 50 次
4. 强制垃圾回收
5. 对比内存占用

**预期结果**:
- ✅ 内存增长 < 20%
- ✅ 无持续增长
- ✅ GC 后恢复正常

---

### 测试用例 10: FPS 稳定性测试

**步骤**:
1. 打开 Chrome DevTools -> Performance
2. 开始录制
3. 切换地图多次
4. 停止录制，查看 FPS

**预期结果**:
- ✅ FPS 稳定在 60
- ✅ 切换时无明显掉帧
- ✅ 动画流畅

---

## 🐛 问题排查

### 如果地图不显示

**检查项**:
1. 控制台是否有报错？
2. 网络请求是否成功？
3. geoJson 数据是否正确加载？
4. DOM 容器是否存在？

**解决方案**:
```javascript
// 在控制台执行
console.log('缓存状态:', globalMapCache);
console.log('当前 cacheKey:', cacheKey);
```

---

### 如果切换卡顿

**检查项**:
1. 是否在控制台看到 "使用缓存的地图"？
2. 是否有重复初始化？
3. FPS 是否正常？

**解决方案**:
```javascript
// 检查是否有重复初始化
// 控制台应该只显示一次初始化日志
```

---

### 如果视角不正确

**检查项**:
1. 相机参数是否正确？
2. 地图缩放动画是否完成？

**解决方案**:
```typescript
// 调整 src/map3d/camera.ts
const camera = new THREE.PerspectiveCamera(
  35,  // 调整这个值 (25-45)
  ...
);
const zPosition = mapType === "world" ? 300 : 180; // 调整这个值
```

---

## ✅ 测试检查表

### 功能测试
- [ ] 首次加载中国地图
- [ ] 首次加载世界地图
- [ ] 切换到已加载地图（缓存）
- [ ] 快速连续切换
- [ ] Loading 动画显示
- [ ] Tooltip 功能正常
- [ ] 地图交互正常

### 性能测试
- [ ] 首次加载 < 500ms
- [ ] 缓存切换 < 100ms
- [ ] FPS 稳定 60
- [ ] 无内存泄漏
- [ ] CPU 占用正常

### 视觉测试
- [ ] 中国地图完整可见
- [ ] 世界地图完整可见
- [ ] 地图居中显示
- [ ] 无需手动调整视角
- [ ] 动画流畅

### 边界测试
- [ ] 快速切换不出错
- [ ] 长时间运行稳定
- [ ] 调整窗口大小正常
- [ ] 刷新页面正常

---

## 📈 测试报告模板

```markdown
### 测试日期: 2025-12-14
### 测试环境: Chrome 120 / Windows 11
### 测试版本: v2.0.1

#### 功能测试结果
- ✅ 所有功能正常
- ✅ 缓存机制工作正常
- ✅ 切换流畅无卡顿

#### 性能测试结果
- ✅ 首次加载: 287ms (中国), 341ms (世界)
- ✅ 缓存切换: 42ms (平均)
- ✅ FPS: 60 (稳定)
- ✅ 内存: 正常

#### 问题记录
- 无

#### 结论
**通过 ✅**
```

---

## 🎯 自动化测试建议

如果需要自动化测试，可以使用：

```typescript
// 使用 Jest + React Testing Library
describe('Map3D 切换测试', () => {
  it('应该正确缓存地图', async () => {
    const { getByText } = render(<MapComponent />);
    
    // 切换到世界地图
    fireEvent.click(getByText('世界地图'));
    await waitFor(() => expect(globalMapCache['world-195']).toBeDefined());
    
    // 切换回中国地图
    fireEvent.click(getByText('中国地图'));
    await waitFor(() => expect(screen.queryByText('加载中')).not.toBeInTheDocument());
  });
});
```

---

**文档版本**: v1.0  
**最后更新**: 2025-12-14

