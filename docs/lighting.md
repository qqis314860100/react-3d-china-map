# 地图“中心光斑/灯光高亮”说明（世界 vs 中国）

## 现象
- **世界地图**：画面中间（欧洲附近）会出现明显的受光更亮区域，像“灯光打在中间”。
- **中国地图（改动前）**：整体亮度更均匀，不会出现类似“中心光斑”。
- **中国地图（改动后）**：以**宁德**为中心出现“中心光斑”，效果与世界地图类似。

## 原因（为什么世界会有“中间更亮”）
1. **地图面材质会受灯光影响**  
   地图主体使用 `MeshLambertMaterial`（Lambert 漫反射材质），天然会因为灯光方向/距离产生明暗变化。

2. **世界地图点光源位置固定在原点附近**  
   `worldPointLight` 放在接近 `(0, -5, 35)` 的位置。

3. **世界地图模型会被平移到原点附近居中**  
   世界地图渲染后用包围盒中心 `center` 做了一次 `mapObject3D.position.set(-center.x, -center.y, 0)`。  
   于是：**灯光在原点附近 + 地图也在原点附近** ⇒ 视觉上“中间更亮”。

## 改动前：为什么中国地图不会这样
中国地图的点光源（`chinaPointLight`）原本在 `light.ts` 中用**另一套写死的投影参数**计算宁德的投影坐标：
- `scale` 等参数与实际中国地图渲染使用的 `projectionFnParam` 不一致  
- 结果是：灯光被放到了**地图坐标系之外/非常远的坐标**，对地图表面贡献很弱  
⇒ 视觉上就不会出现明显的“中心光斑”。

## 改动后：如何实现“宁德为中心光斑”
1. **统一坐标系**  
   在 `Map3D` 内部，用与中国地图渲染一致的 `projectionFnParam` 投影宁德经纬度，得到宁德在当前地图坐标系下的 `[x, y]`。

2. **限制影响范围，避免“整张图都变亮”**  
   给 `chinaPointLight` 设置 `distance/decay`（有效半径 + 距离衰减），让它更像“局部光斑”，而不是照亮整张地图。

3. **位置锁定在宁德上方（且不受缩放带来的“拉远/变均匀”影响）**  
   将 `chinaPointLight` 挂在 `scene` 上，并在渲染循环中用 `mapObject3D.localToWorld()` 将宁德的本地坐标转换成世界坐标，再把灯放到该点上方固定高度。  
   这样无论地图平移/缩放动画/轨道控制器旋转，光斑都稳定落在宁德附近，同时不会因为父级缩放导致光源被“拉远”而整图变亮。

4. **坐标方向一致（y 取反）**  
   地图渲染时经纬度投影后使用 `y -> -y` 绘制，所以灯光也按同样规则把 y 取反：`position.set(x, -y, z)`。

## 相关代码位置
- `src/map3d/light.ts`：创建环境光 + 世界/中国点光源（中国点光源位置由 `Map3D` 设置）。
- `src/map3d/index.tsx`：  
  - 计算宁德的投影坐标  
  - 在中国地图分支中把 `chinaPointLight` 放到宁德位置并挂到 `mapObject3D`


